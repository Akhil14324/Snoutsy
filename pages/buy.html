<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy Pets - Snoutsy</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/buy-sell.css">
    <link rel="shortcut icon" href="../assets/Favicon.ico" type="image/jpeg">
</head>
<body>
    <header class="header">
        <a href="../index.html" class="logo"><i class="fa-solid fa-paw"></i>Snoutsy</a>
        <nav class="navbar">
            <a href="../index.html">Home</a>
            <a href="./services.html">Services</a>
            <a href="./about.html">About Us</a>
            <a href="./contact.html">Contact Us</a>
            <a href="./buy.html" class="active">Buy</a>
            <a href="./sell.html">Sell</a>
            <a href="./login.html" class="login-btn" id="login-link">Login</a>
            <div id="user-info" class="user-info" style="display: none;">
                <a href="./profile.html" class="user-profile-link">
                    <img id="user-photo" src="" alt="User" class="user-photo">
                    <span id="user-name" class="user-name"></span>
                </a>
                <button id="logout-btn" class="logout-btn">Logout</button>
            </div>
        </nav>
        <i id="menu-btn" class="fas fa-bars"></i>
    </header>

    <!-- Buy Pets Section -->
    <section class="buy-sell-section">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">Buy Pets</h1>
                <p class="page-subtitle">Find your perfect pet companion from verified sellers</p>
            </div>

            <!-- Search and Filter Bar -->
            <div class="search-filter-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Search pets by name, breed, or type...">
                </div>
                <div class="filter-box">
                    <select id="filter-type" class="filter-select">
                        <option value="all">All Types</option>
                        <option value="dog">Dogs</option>
                        <option value="cat">Cats</option>
                        <option value="bird">Birds</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="filter-price" class="filter-select">
                        <option value="all">All Prices</option>
                        <option value="0-5000">₹0 - ₹5,000</option>
                        <option value="5000-10000">₹5,000 - ₹10,000</option>
                        <option value="10000-20000">₹10,000 - ₹20,000</option>
                        <option value="20000+">₹20,000+</option>
                    </select>
                </div>
            </div>

            <!-- Pets Grid -->
            <div id="pets-grid" class="pets-grid">
                <!-- Pet listings will be dynamically inserted here -->
                <div class="empty-state">
                    <i class="fas fa-dog" style="font-size: 5rem; color: #ccc; margin-bottom: 1rem;"></i>
                    <h3>No pets available yet</h3>
                    <p>Check back soon for new pet listings!</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <section class="footer">
        <div class="footer-content">
           <h3><i class="fa-solid fa-paw"></i>Snoutsy</h3> 
           <p>Snoutsy is a trusted platform for buying, selling, and adopting pets. We connect verified users to ensure secure and responsible pet ownership.</p>
           <ul class="socials">
            <li><a href="#"><i class="fa fa-facebook"></i></a></li>
            <li><a href="#"><i class="fa fa-twitter"></i></a></li>
            <li><a href="#"><i class="fa-brands fa-google"></i></a></li>
            <li><a href="#"><i class="fa fa-youtube"></i></a></li>
            <li><a href="#"><i class="fa fa-linkedin-square"></i></a></li>
         </ul>
        </div>
    </section>
    <section class="footer-bottom">
       <p>copyright &copy;2023 <a href="#">Snoutsy.</a></p>
    </section>

    <script src="https://kit.fontawesome.com/cb8535f973.js" crossorigin="anonymous"></script>
    <script src="../js/script.js"></script>
    <script src="../js/popup.js"></script>
    
    <!-- Firebase Authentication and Firestore for Buy Page -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, where, doc, addDoc, deleteDoc, getDoc, setDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAZnkTV-mK0F7Q4Fm5OeK_vRPHFgGt6Gms",
            authDomain: "snoutsy-df81c.firebaseapp.com",
            projectId: "snoutsy-df81c",
            storageBucket: "snoutsy-df81c.firebasestorage.app",
            messagingSenderId: "636456747643",
            appId: "1:636456747643:web:f62ed4b7fe0b3217b998de",
            measurementId: "G-G13VVSSN6F"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;

        // Get DOM elements
        const loginLink = document.getElementById('login-link');
        const userInfo = document.getElementById('user-info');
        const userPhoto = document.getElementById('user-photo');
        const userName = document.getElementById('user-name');
        const logoutBtn = document.getElementById('logout-btn');
        const petsGrid = document.getElementById('pets-grid');

        // Function to update UI based on auth state
        function updateUI(user) {
            currentUser = user;
            if (user) {
                loginLink.style.display = 'none';
                userInfo.style.display = 'flex';
                userPhoto.src = user.photoURL || 'https://via.placeholder.com/40';
                userPhoto.alt = user.displayName || 'User';
                userName.textContent = user.displayName || 'User';
                // Save user data to Firestore
                saveUserData(user);
            } else {
                loginLink.style.display = 'block';
                userInfo.style.display = 'none';
            }
        }
        
        // Save/Update user data in Firestore
        async function saveUserData(user) {
            try {
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);
                
                const userData = {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL || null,
                    updatedAt: serverTimestamp()
                };

                if (!userSnap.exists()) {
                    userData.createdAt = serverTimestamp();
                    await setDoc(userRef, userData);
                } else {
                    await updateDoc(userRef, userData);
                }
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        // Monitor auth state changes
        onAuthStateChanged(auth, (user) => {
            updateUI(user);
        });

        // Logout functionality
        logoutBtn?.addEventListener('click', async () => {
            try {
                await signOut(auth);
                localStorage.removeItem('user');
                window.location.href = './login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                popupManager.error('Error signing out. Please try again.');
            }
        });

        // Load pets from Firestore
        async function loadPets() {
            try {
                // Get only available pets
                const q = query(collection(db, 'pets'), where('status', '==', 'available'));
                const querySnapshot = await getDocs(q);
                
                const pets = [];
                querySnapshot.forEach((doc) => {
                    pets.push({ id: doc.id, ...doc.data() });
                });
                
                if (pets.length === 0) {
                    petsGrid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-dog" style="font-size: 5rem; color: #ccc; margin-bottom: 1rem;"></i>
                            <h3>No pets available yet</h3>
                            <p>Check back soon for new pet listings!</p>
                        </div>
                    `;
                    return;
                }

                // Load user's favorites
                let favoriteIds = [];
                if (currentUser) {
                    try {
                        const favRef = doc(db, 'favorites', currentUser.uid);
                        const favSnap = await getDoc(favRef);
                        if (favSnap.exists()) {
                            favoriteIds = favSnap.data().petIds || [];
                        }
                    } catch (error) {
                        console.error('Error loading favorites:', error);
                    }
                }

                petsGrid.innerHTML = pets.map(pet => {
                    const isFavorite = favoriteIds.includes(pet.id);
                    return `
                        <div class="pet-card" data-type="${pet.type}" data-price="${pet.price}">
                            <div class="pet-image">
                                <img src="${pet.image || '../assets/Pet1.png'}" alt="${pet.name}">
                                <span class="pet-type-badge">${pet.type}</span>
                                ${currentUser ? `
                                    <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${pet.id}')" title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                ` : ''}
                            </div>
                            <div class="pet-card-content">
                                <h3>${pet.name}</h3>
                                <p class="pet-breed">${pet.breed}</p>
                                <p class="pet-description">${pet.description || 'No description available'}</p>
                                <div class="pet-details">
                                    <span><i class="fas fa-calendar"></i> ${pet.age || 'N/A'}</span>
                                    <span><i class="fas fa-venus-mars"></i> ${pet.gender || 'N/A'}</span>
                                    <span><i class="fas fa-map-marker-alt"></i> ${pet.location || 'N/A'}</span>
                                </div>
                                <div class="pet-price">
                                    <span class="price">₹${pet.price?.toLocaleString() || '0'}</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn-contact" onclick="contactSeller('${pet.sellerId}', '${pet.name}')" style="flex: 1;">
                                        <i class="fas fa-phone"></i> Contact Seller
                                    </button>
                                    ${currentUser && currentUser.uid !== pet.sellerId ? `
                                        <button class="btn-buy" onclick="createOrder('${pet.id}', '${pet.name}', ${pet.price}, '${pet.sellerId}')" style="flex: 1; background: #4EA685; color: white; border: none; padding: 1.2rem; border-radius: 0.5rem; cursor: pointer;">
                                            <i class="fas fa-shopping-cart"></i> Buy Now
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading pets:', error);
                petsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="font-size: 5rem; color: #ccc; margin-bottom: 1rem;"></i>
                        <h3>Error loading pets</h3>
                        <p>Please refresh the page and try again.</p>
                    </div>
                `;
            }
        }
        
        // Toggle favorite
        window.toggleFavorite = async function(petId) {
            if (!currentUser) {
                popupManager.warning('Please login to add favorites.');
                return;
            }

            try {
                const favRef = doc(db, 'favorites', currentUser.uid);
                const favSnap = await getDoc(favRef);
                
                let favoriteIds = [];
                if (favSnap.exists()) {
                    favoriteIds = favSnap.data().petIds || [];
                }

                const index = favoriteIds.indexOf(petId);
                if (index > -1) {
                    // Remove from favorites
                    favoriteIds.splice(index, 1);
                } else {
                    // Add to favorites
                    favoriteIds.push(petId);
                }

                await setDoc(favRef, {
                    userId: currentUser.uid,
                    petIds: favoriteIds,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                // Reload pets to update favorite icons
                loadPets();
            } catch (error) {
                console.error('Error toggling favorite:', error);
                popupManager.error('Error updating favorite. Please try again.');
            }
        };
        
        // Create order
        window.createOrder = async function(petId, petName, price, sellerId) {
            if (!currentUser) {
                popupManager.warning('Please login to buy pets.');
                return;
            }

            if (!confirm(`Are you sure you want to buy ${petName} for ₹${price.toLocaleString()}?`)) {
                return;
            }

            try {
                // Create order
                const orderData = {
                    buyerId: currentUser.uid,
                    buyerName: currentUser.displayName,
                    buyerEmail: currentUser.email,
                    petId: petId,
                    petName: petName,
                    sellerId: sellerId,
                    price: price,
                    status: 'pending', // pending, confirmed, completed, cancelled
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                const orderRef = await addDoc(collection(db, 'orders'), orderData);

                // Create transaction
                const transactionData = {
                    orderId: orderRef.id,
                    buyerId: currentUser.uid,
                    sellerId: sellerId,
                    amount: price,
                    type: 'purchase',
                    status: 'pending',
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, 'transactions'), transactionData);

                // Update pet status to pending
                const petRef = doc(db, 'pets', petId);
                await updateDoc(petRef, {
                    status: 'pending',
                    orderId: orderRef.id,
                    updatedAt: serverTimestamp()
                });

                popupManager.success(`Order created successfully! Order ID: ${orderRef.id}`);
                loadPets();
            } catch (error) {
                console.error('Error creating order:', error);
                popupManager.error('Error creating order. Please try again.');
            }
        };

        // Search and filter functionality
        document.getElementById('search-input')?.addEventListener('input', filterPets);
        document.getElementById('filter-type')?.addEventListener('change', filterPets);
        document.getElementById('filter-price')?.addEventListener('change', filterPets);

        function filterPets() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('filter-type').value;
            const priceFilter = document.getElementById('filter-price').value;
            const petCards = document.querySelectorAll('.pet-card');

            petCards.forEach(card => {
                const petName = card.querySelector('h3').textContent.toLowerCase();
                const petType = card.getAttribute('data-type');
                const petPrice = parseInt(card.getAttribute('data-price'));

                const matchesSearch = petName.includes(searchTerm);
                const matchesType = typeFilter === 'all' || petType === typeFilter;
                const matchesPrice = priceFilter === 'all' || checkPriceRange(petPrice, priceFilter);

                if (matchesSearch && matchesType && matchesPrice) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function checkPriceRange(price, range) {
            switch(range) {
                case '0-5000': return price >= 0 && price <= 5000;
                case '5000-10000': return price > 5000 && price <= 10000;
                case '10000-20000': return price > 10000 && price <= 20000;
                case '20000+': return price > 20000;
                default: return true;
            }
        }

        // Contact seller function
        window.contactSeller = async function(sellerId, petName) {
            try {
                const sellerRef = doc(db, 'users', sellerId);
                const sellerSnap = await getDoc(sellerRef);
                
                if (sellerSnap.exists()) {
                    const seller = sellerSnap.data();
                    popupManager.info(`Contact Seller for ${petName}:\n\nName: ${seller.displayName || 'N/A'}\nEmail: ${seller.email || 'N/A'}\n\nYou can contact them via email.`);
                } else {
                    popupManager.info(`Contacting seller for ${petName}. Please check your email for seller contact details.`);
                }
            } catch (error) {
                console.error('Error getting seller info:', error);
                popupManager.info(`Contacting seller for ${petName}. Please check your email for seller contact details.`);
            }
        };

        // Load pets on page load
        loadPets();
    </script>
</body>
</html>

